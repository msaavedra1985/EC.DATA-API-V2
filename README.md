# EC.DATA API - Enterprise REST API

API REST empresarial construida con Node.js, Express, PostgreSQL y Redis. Sistema completo de autenticaci√≥n JWT con control de acceso basado en roles (RBAC).

## üöÄ Caracter√≠sticas Principales

- ‚úÖ **Autenticaci√≥n JWT** con claims est√°ndar RFC 7519
- ‚úÖ **Sistema RBAC** con 7 roles en base de datos
- ‚úÖ **Cach√© Redis** para optimizaci√≥n de rendimiento
- ‚úÖ **Validaci√≥n robusta** con Zod
- ‚úÖ **Documentaci√≥n Swagger** en `/docs`
- ‚úÖ **M√©tricas Prometheus** en `/metrics`
- ‚úÖ **Logging estructurado** con Pino (worker threads)
- ‚úÖ **Multi-idioma** (Espa√±ol e Ingl√©s)

## üìã Requisitos

- Node.js 20+
- PostgreSQL 14+
- Redis (opcional, usa fallback en memoria)

## üîß Instalaci√≥n

```bash
# Instalar dependencias
npm install

# Configurar variables de entorno
cp .env.example .env

# Iniciar servidor de desarrollo
npm run dev

# Sincronizar esquema de base de datos
npm run db:push
```

## üîê Sistema de Autenticaci√≥n JWT

### Estructura de Tokens

El sistema implementa autenticaci√≥n JWT dual con:

- **Access Token**: V√°lido por 15 minutos
- **Refresh Token**: V√°lido por 14 d√≠as, almacenado en BD

#### Claims Est√°ndar (RFC 7519)

```javascript
{
  "iss": "https://api.ec.com",           // Emisor
  "aud": "ec-frontend",                  // Audiencia
  "sub": "user-uuid",                    // Usuario (subject)
  "iat": 1234567890,                     // Fecha de emisi√≥n
  "exp": 1234568790,                     // Fecha de expiraci√≥n
  "jti": "token-uuid",                   // ID √∫nico del token
  "orgId": "org-uuid",                   // Organizaci√≥n
  "sessionVersion": 1,                   // Versi√≥n de sesi√≥n
  "tokenType": "access",                 // Tipo de token
  "role": {                              // Rol del usuario
    "id": "role-uuid",
    "name": "user",
    "description": "...",
    "is_active": true
  }
}
```

### Endpoints de Autenticaci√≥n

Todos los ejemplos asumen que el servidor est√° corriendo en `http://localhost:5000`.

#### Registrar Usuario

```bash
# Ejemplo ejecutable con curl
curl -X POST http://localhost:5000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario@example.com",
    "password": "SecurePass123!",
    "first_name": "Juan",
    "last_name": "P√©rez"
  }'
```

**Respuesta:**
```json
{
  "ok": true,
  "data": {
    "user": {
      "id": "0199baa7-ff28-743c-9673-6bed636d0f33",
      "email": "usuario@example.com",
      "first_name": "Juan",
      "last_name": "P√©rez",
      "role": {
        "id": "0199ba9c-0c65-742d-80cc-5584d87678a6",
        "name": "user",
        "description": "Usuario est√°ndar"
      }
    },
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": "15m",
    "token_type": "Bearer"
  }
}
```

#### Iniciar Sesi√≥n

```bash
# Login y guardar tokens en variables de entorno
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario@example.com",
    "password": "SecurePass123!"
  }' | jq -r '.data | "export ACCESS_TOKEN=\(.access_token)\nexport REFRESH_TOKEN=\(.refresh_token)"'

# Ejemplo simple
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario@example.com",
    "password": "SecurePass123!"
  }'
```

**Respuesta:**
```json
{
  "ok": true,
  "data": {
    "user": {
      "id": "0199baa7-ff28-743c-9673-6bed636d0f33",
      "email": "usuario@example.com",
      "first_name": "Juan",
      "last_name": "P√©rez",
      "role": {
        "name": "user",
        "description": "Usuario est√°ndar"
      }
    },
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2FwaS5lYy5jb20iLCJhdWQiOiJlYy1mcm9udGVuZCIsInN1YiI6IjAxOTliYWE3LWZmMjgtNzQzYy05NjczLTZiZWQ2MzZkMGYzMyIsIm9yZ0lkIjpudWxsLCJzZXNzaW9uVmVyc2lvbiI6MSwicm9sZSI6eyJpZCI6IjAxOTliYTljLTBjNjUtNzQyZC04MGNjLTU1ODRkODc2NzhhNiIsIm5hbWUiOiJ1c2VyIn0sInRva2VuVHlwZSI6ImFjY2VzcyIsImp0aSI6IjEyMzQ1Njc4LTEyMzQtMTIzNC0xMjM0LTEyMzQ1Njc4OTBhYiIsImlhdCI6MTcwMDAwMDAwMCwiZXhwIjoxNzAwMDAwOTAwfQ...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2FwaS5lYy5jb20iLCJhdWQiOiJlYy1mcm9udGVuZCIsInN1YiI6IjAxOTliYWE3LWZmMjgtNzQzYy05NjczLTZiZWQ2MzZkMGYzMyIsInRva2VuVHlwZSI6InJlZnJlc2giLCJqdGkiOiI5ODc2NTQzMi0xMjM0LTEyMzQtMTIzNC0wOTg3NjU0MzIxYWIiLCJpYXQiOjE3MDAwMDAwMDAsImV4cCI6MTcwMTIwOTYwMH0...",
    "expires_in": "15m",
    "token_type": "Bearer"
  },
  "meta": {
    "timestamp": "2025-10-06T17:00:00.000Z"
  }
}
```

#### Refrescar Token

```bash
# Usar refresh token para obtener nuevo access token
curl -X POST http://localhost:5000/api/v1/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refresh_token": "'"$REFRESH_TOKEN"'"
  }'

# Con token literal
curl -X POST http://localhost:5000/api/v1/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }'
```

**Respuesta:**
```json
{
  "ok": true,
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2FwaS5lYy5jb20iLCJhdWQiOiJlYy1mcm9udGVuZCIsInN1YiI6IjAxOTliYWE3LWZmMjgtNzQzYy05NjczLTZiZWQ2MzZkMGYzMyIsIm9yZ0lkIjpudWxsLCJzZXNzaW9uVmVyc2lvbiI6MSwicm9sZSI6eyJpZCI6IjAxOTliYTljLTBjNjUtNzQyZC04MGNjLTU1ODRkODc2NzhhNiIsIm5hbWUiOiJ1c2VyIn0sInRva2VuVHlwZSI6ImFjY2VzcyIsImp0aSI6ImFiY2RlZjEyLTEyMzQtMTIzNC0xMjM0LTEyMzQ1Njc4OTBhYiIsImlhdCI6MTcwMDAwMTAwMCwiZXhwIjoxNzAwMDAxOTAwfQ...",
    "expires_in": "15m",
    "token_type": "Bearer"
  },
  "meta": {
    "timestamp": "2025-10-06T17:01:00.000Z"
  }
}
```

#### Obtener Usuario Actual

```bash
# Usando variable de entorno
curl -X GET http://localhost:5000/api/v1/auth/me \
  -H "Authorization: Bearer $ACCESS_TOKEN"

# Con token literal
curl -X GET http://localhost:5000/api/v1/auth/me \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**Respuesta:**
```json
{
  "ok": true,
  "data": {
    "id": "0199baa7-ff28-743c-9673-6bed636d0f33",
    "human_id": 1,
    "public_code": "EC-001-U-8",
    "email": "usuario@example.com",
    "first_name": "Juan",
    "last_name": "P√©rez",
    "is_active": true,
    "last_login_at": "2025-10-06T17:00:00.000Z",
    "role": {
      "id": "0199ba9c-0c65-742d-80cc-5584d87678a6",
      "name": "user",
      "description": "Usuario est√°ndar"
    },
    "organization_id": null
  },
  "meta": {
    "timestamp": "2025-10-06T17:02:00.000Z"
  }
}
```

#### Cerrar Sesi√≥n

```bash
# Cerrar sesi√≥n actual (invalida el refresh token espec√≠fico)
curl -X POST http://localhost:5000/api/v1/auth/logout \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "refresh_token": "'"$REFRESH_TOKEN"'"
  }'

# Con tokens literales
curl -X POST http://localhost:5000/api/v1/auth/logout \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }'
```

**Respuesta:**
```json
{
  "ok": true,
  "data": {
    "message": "Sesi√≥n cerrada exitosamente"
  },
  "meta": {
    "timestamp": "2025-10-06T17:03:00.000Z"
  }
}
```

#### Cerrar Todas las Sesiones

```bash
# Invalida todos los refresh tokens del usuario (con variable)
curl -X POST http://localhost:5000/api/v1/auth/logout-all \
  -H "Authorization: Bearer $ACCESS_TOKEN"

# Con token literal
curl -X POST http://localhost:5000/api/v1/auth/logout-all \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**Respuesta:**
```json
{
  "ok": true,
  "data": {
    "message": "Todas las sesiones han sido cerradas",
    "sessions_revoked": 3
  },
  "meta": {
    "timestamp": "2025-10-06T17:04:00.000Z"
  }
}
```

#### Cambiar Contrase√±a

```bash
# Cambiar contrase√±a (invalida todas las sesiones excepto la actual)
curl -X POST http://localhost:5000/api/v1/auth/change-password \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "current_password": "SecurePass123!",
    "new_password": "NewSecurePass456!"
  }'

# Con token literal
curl -X POST http://localhost:5000/api/v1/auth/change-password \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "current_password": "SecurePass123!",
    "new_password": "NewSecurePass456!"
  }'
```

**Respuesta:**
```json
{
  "ok": true,
  "data": {
    "message": "Contrase√±a actualizada exitosamente",
    "sessions_revoked": 2
  },
  "meta": {
    "timestamp": "2025-10-06T17:05:00.000Z"
  }
}
```

## üë• Sistema RBAC (Role-Based Access Control)

### Roles Disponibles

El sistema cuenta con 7 roles predefinidos con jerarqu√≠a de permisos:

| Rol | Nombre | Descripci√≥n |
|-----|--------|-------------|
| 1Ô∏è‚É£ | `system-admin` | Administrador del sistema. Acceso total a todas las funciones, incluyendo gesti√≥n de organizaciones, usuarios globales y configuraciones del sistema. |
| 2Ô∏è‚É£ | `org-admin` | Administrador de organizaci√≥n. Acceso completo dentro de su organizaci√≥n: gesti√≥n de usuarios, configuraciones, facturaci√≥n y contenido. |
| 3Ô∏è‚É£ | `org-manager` | Gerente de organizaci√≥n. Supervisi√≥n y reportes dentro de la organizaci√≥n, puede aprobar acciones y gestionar equipos, sin configuraci√≥n de sistema. |
| 4Ô∏è‚É£ | `user` | Usuario est√°ndar. Acceso a secciones habilitadas; puede crear/ver contenido propio o de equipo (ej: subir facturas, ver dashboards), sin gesti√≥n de usuarios. |
| 5Ô∏è‚É£ | `viewer` | Visualizador. Solo lectura de contenido permitido, sin capacidades de edici√≥n, creaci√≥n o configuraci√≥n. |
| 6Ô∏è‚É£ | `guest` | Invitado. Acceso temporal limitado con permisos m√≠nimos para √°reas p√∫blicas o de prueba. |
| 7Ô∏è‚É£ | `demo` | Cuenta demo. Para demostraciones; acceso limitado con datos de ejemplo, sin capacidad de modificar configuraciones reales. |

### Middleware de Autorizaci√≥n

#### `authenticate`
Valida el token JWT y carga el usuario en `req.user`:

```javascript
import { authenticate } from './middleware/auth.js';

router.get('/protected', authenticate, (req, res) => {
  // req.user est√° disponible
  res.json({ user: req.user });
});
```

#### `requireRole(...roles)`
Restringe acceso a roles espec√≠ficos:

```javascript
import { authenticate, requireRole } from './middleware/auth.js';

// Solo system-admin y org-admin pueden acceder
router.post('/admin/users', 
  authenticate, 
  requireRole(['system-admin', 'org-admin']), 
  createUser
);

// Solo usuarios autenticados (cualquier rol)
router.get('/dashboard', authenticate, getDashboard);
```

### M√©todos de Usuario

```javascript
// Verificar si tiene un rol espec√≠fico
if (user.hasRole('system-admin')) {
  // Acciones de admin
}

// Verificar si es admin del sistema
if (user.isSystemAdmin()) {
  // Acciones exclusivas
}

// Verificar si es admin de organizaci√≥n
if (user.isOrgAdmin()) {
  // Acciones de org-admin
}
```

## üóÑÔ∏è Cach√© y Sesiones

### Cach√© Redis de Usuarios

Los datos de usuario se cachean en Redis por 15 minutos para optimizar rendimiento:

```javascript
// Flujo de validaci√≥n de token
1. Verificar token JWT
2. Buscar usuario en cach√© Redis (TTL: 15min)
3. Si no existe en cach√©, consultar PostgreSQL
4. Guardar en cach√© para futuras peticiones
```

### Invalidaci√≥n de Sesiones

El sistema soporta invalidaci√≥n instant√°nea de sesiones mediante `sessionVersion`:

```javascript
// Incrementar sessionVersion invalida todos los tokens del usuario
await invalidateUserSession(userId);

// Causas de invalidaci√≥n autom√°tica:
- Cambio de contrase√±a
- Logout de todas las sesiones
- Desactivaci√≥n de cuenta
- Detecci√≥n de robo de token
```

## üß™ Usuarios de Prueba

Para testing del sistema RBAC:

| Email | Contrase√±a | Rol | Uso |
|-------|-----------|-----|-----|
| `orgadmin2@test.com` | `AdminPass123!` | `org-admin` | Testing de endpoints protegidos para admins |
| `testrbac2@example.com` | `SecurePass123!` | `user` | Testing de usuario est√°ndar |

### Endpoint de Prueba RBAC

```bash
# Testing con org-admin (debe permitir acceso)
GET /api/v1/auth/admin-test
Authorization: Bearer {admin_access_token}

# Testing con usuario regular (debe denegar con 403)
GET /api/v1/auth/admin-test
Authorization: Bearer {user_access_token}
```

## üìö Documentaci√≥n API

La documentaci√≥n completa de la API est√° disponible en:

```
http://localhost:5000/docs
```

Incluye todos los endpoints, schemas, ejemplos de request/response y autenticaci√≥n.

## üéØ Endpoints Principales

| M√©todo | Endpoint | Descripci√≥n | Autenticaci√≥n |
|--------|----------|-------------|---------------|
| POST | `/api/v1/auth/register` | Registrar nuevo usuario | ‚ùå |
| POST | `/api/v1/auth/login` | Iniciar sesi√≥n | ‚ùå |
| POST | `/api/v1/auth/refresh` | Refrescar access token | ‚ùå |
| GET | `/api/v1/auth/me` | Obtener usuario actual | ‚úÖ |
| POST | `/api/v1/auth/logout` | Cerrar sesi√≥n actual | ‚úÖ |
| POST | `/api/v1/auth/logout-all` | Cerrar todas las sesiones | ‚úÖ |
| GET | `/api/v1/auth/sessions` | Listar sesiones activas | ‚úÖ |
| POST | `/api/v1/auth/change-password` | Cambiar contrase√±a | ‚úÖ |
| GET | `/api/v1/health` | Health check | ‚ùå |
| GET | `/metrics` | M√©tricas Prometheus | ‚ùå |

## üîí Seguridad

- ‚úÖ Passwords hasheados con bcrypt (10 rounds)
- ‚úÖ Refresh tokens hasheados con SHA-256 en BD
- ‚úÖ Validaci√≥n de claims JWT (iss, aud, exp)
- ‚úÖ CORS configurado con or√≠genes din√°micos
- ‚úÖ Helmet para headers de seguridad
- ‚úÖ Rate limiting (modo observaci√≥n)
- ‚úÖ Auditor√≠a de sesiones (user-agent, IP)
- ‚úÖ Detecci√≥n de robo de tokens
- ‚úÖ Expiraci√≥n y limpieza autom√°tica de tokens

## üìä Observabilidad

### Logging (Pino)
```javascript
// Logs estructurados en JSON
logger.info({ userId, action }, 'User logged in');
logger.error({ error, context }, 'Operation failed');
```

### M√©tricas (Prometheus)
- Duraci√≥n de requests HTTP
- Contadores de requests por endpoint
- Conexiones activas
- M√©tricas personalizadas de negocio

## üåç Internacionalizaci√≥n

El sistema soporta m√∫ltiples idiomas:

- **Espa√±ol** (es) - idioma por defecto
- **Ingl√©s** (en)

Los mensajes se traducen autom√°ticamente seg√∫n:
1. Header `Accept-Language`
2. Query param `?lang=es`
3. Idioma por defecto del sistema

## üõ†Ô∏è Scripts NPM

```bash
npm run dev          # Desarrollo con hot-reload
npm run start        # Producci√≥n
npm run db:push      # Sincronizar schema a BD
npm run db:dbml      # Generar diagrama DBML
npm test             # Ejecutar tests
```

## üìÅ Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îî‚îÄ‚îÄ auth/              # M√≥dulo de autenticaci√≥n
‚îÇ       ‚îú‚îÄ‚îÄ index.js       # Rutas
‚îÇ       ‚îú‚îÄ‚îÄ services.js    # L√≥gica de negocio
‚îÇ       ‚îú‚îÄ‚îÄ repository.js  # Acceso a datos
‚îÇ       ‚îú‚îÄ‚îÄ cache.js       # Cach√© Redis
‚îÇ       ‚îú‚îÄ‚îÄ dtos/          # Validaci√≥n Zod
‚îÇ       ‚îî‚îÄ‚îÄ models/        # Modelos Sequelize
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.js           # Autenticaci√≥n y autorizaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ validate.js       # Validaci√≥n de requests
‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.js   # Manejo de errores
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ env.js            # Variables de entorno
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ logger.js         # Logger Pino
    ‚îî‚îÄ‚îÄ response.js       # Helpers de respuesta
```

## üö¶ Variables de Entorno

```env
# Servidor
NODE_ENV=development
PORT=5000

# Base de datos
DATABASE_URL=postgresql://user:pass@host:5432/db

# Redis (opcional)
REDIS_URL=redis://localhost:6379

# JWT Secrets
JWT_ACCESS_SECRET=your-secret-key
JWT_REFRESH_SECRET=your-refresh-secret
JWT_ACCESS_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=14d
```

## ü§ù Contribuci√≥n

El proyecto sigue est√°ndares estrictos de c√≥digo:

- **Idioma:** C√≥digo en ingl√©s, comentarios en espa√±ol
- **Sintaxis:** Arrow functions, ESM modules
- **Estilo:** Single quotes, comentarios extensivos
- **Arquitectura:** Feature-based, separaci√≥n en capas

## üìù Licencia

Propiedad de EC.DATA - Enterprise Data Solutions

---

**Versi√≥n:** 1.0.0  
**√öltima actualizaci√≥n:** Octubre 2025  
**Contacto:** api-support@ecdata.com
