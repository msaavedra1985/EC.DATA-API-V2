// Database Schema - Generated on 2025-10-05T03:28:32.022Z
// Project: API EC ESM - Enterprise REST API
// Use this file at https://dbdiagram.io to visualize the schema

// Tabla de referencia de países con códigos ISO 3166-1
Table countries {
  id integer [pk, not null, increment] // ID incremental - tabla de referencia
  iso_alpha2 varchar(2) [unique, not null] // Código ISO 3166-1 alpha-2 (ej: AR, US, ES)
  iso_alpha3 varchar(3) [unique, not null] // Código ISO 3166-1 alpha-3 (ej: ARG, USA, ESP)
  iso_numeric varchar(3) [unique, not null] // Código ISO 3166-1 numérico (ej: 032, 840, 724)
  phone_code varchar(10) // Código telefónico internacional (ej: +54, +1, +34)
  is_active boolean [not null, default: true] // Indica si el país está activo en el sistema
  created_at timestamptz [not null]
  updated_at timestamptz [not null]

  Indexes {
    (is_active) [name: 'countries_is_active']
    (iso_alpha2) [name: 'countries_iso_alpha2']
    (iso_alpha2) [name: 'countries_iso_alpha2_key', unique]
    (iso_alpha3) [name: 'countries_iso_alpha3']
    (iso_alpha3) [name: 'countries_iso_alpha3_key', unique]
    (iso_numeric) [name: 'countries_iso_numeric_key', unique]
  }
}

// Traducciones de nombres de países en múltiples idiomas
Table country_translations {
  id integer [pk, not null, increment]
  country_id integer [not null] // FK a tabla countries
  lang varchar(5) [not null] // Código de idioma (es, en, pt, etc.)
  name varchar(100) [not null] // Nombre del país en el idioma especificado
  official_name varchar(200) // Nombre oficial completo del país
  created_at timestamptz [not null]
  updated_at timestamptz [not null]

  Indexes {
    (lang) [name: 'country_translations_lang']
    (country_id, lang) [name: 'unique_country_lang', unique]
  }
}

// Organizaciones/tenants del sistema con identificadores UUID v7
Table organizations {
  id uuid [pk, not null] // UUID v7 - clave primaria time-ordered
  human_id integer [unique, not null] // ID incremental global para uso interno/soporte
  public_code varchar(50) [unique, not null] // ID público opaco (ej: ORG-7K9D2-X) - previene enumeración
  slug varchar(100) [unique, not null] // Slug único de la organización (ej: acme, techcorp)
  name varchar(200) [not null] // Nombre de la organización
  country_id integer [not null] // FK a tabla countries - país de la organización
  tax_id varchar(50) // Identificación fiscal (CUIT, RFC, EIN, etc.)
  email varchar(255) // Email de contacto de la organización
  phone varchar(50) // Teléfono de contacto
  address text // Dirección física de la organización
  settings jsonb // Configuración JSON de la organización
  is_active boolean [not null, default: true] // Indica si la organización está activa
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
  deleted_at timestamptz

  Indexes {
    (country_id) [name: 'organizations_country_id']
    (email) [name: 'organizations_email']
    (human_id) [name: 'organizations_human_id']
    (human_id) [name: 'organizations_human_id_key', unique]
    (is_active) [name: 'organizations_is_active']
    (public_code) [name: 'organizations_public_code']
    (public_code) [name: 'organizations_public_code_key', unique]
    (slug) [name: 'organizations_slug']
    (slug) [name: 'organizations_slug_key', unique]
  }
}

// Refresh tokens para rotación y gestión de sesiones JWT
Table refresh_tokens {
  id uuid [pk, not null] // UUID v7 - clave primaria time-ordered
  user_id uuid [not null] // FK a users - dueño de la sesión
  token_hash varchar(64) [unique, not null] // SHA-256 hash del refresh token (nunca almacenar en claro)
  expires_at timestamptz [not null] // Fecha de expiración absoluta del token (14 días desde creación)
  last_used_at timestamptz [not null] // Última vez que se usó para refresh (para idle timeout de 7 días)
  is_revoked boolean [not null, default: false] // Token revocado manualmente (logout, password change, detección de robo)
  revoked_at timestamptz // Timestamp de revocación (null si no revocado)
  revoked_reason enum_refresh_tokens_revoked_reason // Motivo de revocación para auditoría
  user_agent text // User agent del navegador (solo para auditoría, no validación)
  ip_address varchar(45) // IP del cliente en formato IPv4 o IPv6 (solo para auditoría, no validación)
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
  deleted_at timestamptz

  Indexes {
    (expires_at, is_revoked) [name: 'idx_refresh_tokens_cleanup']
    (expires_at) [name: 'idx_refresh_tokens_expires_at']
    (is_revoked) [name: 'idx_refresh_tokens_is_revoked']
    (token_hash) [name: 'idx_refresh_tokens_token_hash', unique]
    (user_id) [name: 'idx_refresh_tokens_user_id']
    (token_hash) [name: 'refresh_tokens_token_hash_key', unique]
  }
}

// Usuarios del sistema con autenticación JWT
Table users {
  id uuid [pk, not null] // UUID v7 - clave primaria time-ordered
  human_id integer [not null] // ID incremental scoped por organization_id (solo uso interno/soporte)
  public_code varchar(50) [unique, not null] // ID público opaco (ej: EC-7K9D2-X) - previene enumeración
  email varchar(255) [unique, not null] // Email único para login
  password_hash varchar(255) [not null] // Hash bcrypt de la contraseña (nunca devolver al cliente)
  first_name varchar(100) [not null] // Nombre del usuario
  last_name varchar(100) [not null] // Apellido del usuario
  role enum_users_role [not null] // Rol para control de acceso basado en roles (RBAC)
  organization_id uuid // FK a organizations para multi-tenancy (null = usuario global)
  is_active boolean [not null, default: true] // Usuario activo/inactivo (soft disable)
  last_login_at timestamptz // Última fecha de login exitoso
  email_verified_at timestamptz // Fecha de verificación de email (null = no verificado)
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
  deleted_at timestamptz

  Indexes {
    (email) [name: 'users_email_key', unique]
    (email) [name: 'users_email_unique', unique]
    (is_active) [name: 'users_is_active_idx']
    (human_id, organization_id) [name: 'users_org_human_id_unique', unique]
    (organization_id) [name: 'users_organization_id_idx']
    (public_code) [name: 'users_public_code_key', unique]
    (public_code) [name: 'users_public_code_unique', unique]
    (role) [name: 'users_role_idx']
  }
}


// Foreign Key References
Ref: country_translations.country_id > countries.id [update: cascade, delete: cascade]
Ref: organizations.country_id > countries.id [update: cascade, delete: restrict]
Ref: refresh_tokens.user_id > users.id [update: cascade, delete: cascade]
Ref: users.organization_id > organizations.id [update: cascade, delete: restrict]
